# Run when commits are pushed to mainline branch (main or master)
# Set this to the mainline branch you are using
trigger: none 
  
# Azure Pipelines workflow to deploy to Azure using azd
# To configure required secrets for connecting to Azure, simply run `azd pipeline config --provider azdo`

pool:
  vmImage: ubuntu-latest

parameters:
- name: globallyUniqueName
  displayName: Enter a globally unique name
  type: string
  default: structurizr
    
variables:
  subscription: 'subscription'
  resourceGroup: 'rg-${{parameters.globallyUniqueName}}'
  storageAccountName: 'sa${{lower(parameters.globallyUniqueName)}}'
  appServiceName: 'web${{parameters.globallyUniqueName}}'

steps:
  - checkout: self

  - task: AzurePowerShell@5
    displayName: 'Deploy resources'
    inputs:
      azureSubscription: ${{variables.subscription}}
      scriptType: FilePath
      scriptPath: $(Agent.BuildDirectory)/deploy.ps1
      scriptArguments: 
        -resourceGroup ${{variables.resourceGroup}} `
        -storageAccountName ${{variables.storageAccountName}} `
        -appServiceName ${{variables.appServiceName}}
      azurePowerShellVersion: latestVersion
      pwsh: true